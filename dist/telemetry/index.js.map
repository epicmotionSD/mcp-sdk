{"version":3,"sources":["../../src/telemetry/index.ts"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["export interface TelemetryConfig {\n  /** Your OpenConductor API key */\n  apiKey: string\n  /** Server name for identification */\n  serverName: string\n  /** Server version */\n  serverVersion?: string\n  /** Custom endpoint (default: OpenConductor production) */\n  endpoint?: string\n  /** Batch size before flushing (default: 10) */\n  batchSize?: number\n  /** Flush interval in ms (default: 30000) */\n  flushInterval?: number\n  /** Enable debug logging (default: false) */\n  debug?: boolean\n}\n\nexport interface ToolMetric {\n  tool: string\n  duration: number\n  success: boolean\n  error?: string\n  timestamp: string\n}\n\nexport interface TelemetryBatch {\n  serverName: string\n  serverVersion?: string\n  metrics: ToolMetric[]\n  meta: {\n    sdkVersion: string\n    nodeVersion: string\n    platform: string\n  }\n}\n\nconst SDK_VERSION = '1.0.0'\nconst DEFAULT_ENDPOINT = 'https://api.openconductor.ai/functions/v1/telemetry'\n\nlet globalTelemetry: Telemetry | null = null\n\n/**\n * Initialize telemetry for your MCP server\n * Call this once at startup with your OpenConductor API key\n */\nexport function initTelemetry(config: TelemetryConfig): Telemetry {\n  globalTelemetry = new Telemetry(config)\n  return globalTelemetry\n}\n\n/**\n * Get the global telemetry instance (if initialized)\n */\nexport function getTelemetry(): Telemetry | null {\n  return globalTelemetry\n}\n\n\nexport class Telemetry {\n  private config: Required<Omit<TelemetryConfig, 'serverVersion'>> & Pick<TelemetryConfig, 'serverVersion'>\n  private buffer: ToolMetric[] = []\n  private flushTimer: ReturnType<typeof setInterval> | null = null\n\n  constructor(config: TelemetryConfig) {\n    this.config = {\n      apiKey: config.apiKey,\n      serverName: config.serverName,\n      serverVersion: config.serverVersion,\n      endpoint: config.endpoint ?? DEFAULT_ENDPOINT,\n      batchSize: config.batchSize ?? 10,\n      flushInterval: config.flushInterval ?? 30000,\n      debug: config.debug ?? false,\n    }\n\n    // Start periodic flush\n    this.flushTimer = setInterval(() => {\n      this.flush().catch(this.handleError.bind(this))\n    }, this.config.flushInterval)\n\n    // Flush on process exit\n    if (typeof process !== 'undefined') {\n      process.on('beforeExit', () => this.flush())\n      process.on('SIGINT', () => {\n        this.flush().finally(() => process.exit(0))\n      })\n      process.on('SIGTERM', () => {\n        this.flush().finally(() => process.exit(0))\n      })\n    }\n\n    this.log('Telemetry initialized', { serverName: config.serverName })\n  }\n\n  /**\n   * Track a tool invocation\n   */\n  trackToolCall(\n    tool: string,\n    duration: number,\n    success: boolean,\n    error?: string\n  ): void {\n    const metric: ToolMetric = {\n      tool,\n      duration,\n      success,\n      ...(error && { error }),\n      timestamp: new Date().toISOString(),\n    }\n\n    this.buffer.push(metric)\n    this.log('Metric tracked', { ...metric })\n\n    // Auto-flush if buffer is full\n    if (this.buffer.length >= this.config.batchSize) {\n      this.flush().catch(this.handleError.bind(this))\n    }\n  }\n\n  /**\n   * Flush buffered metrics to OpenConductor\n   */\n  async flush(): Promise<void> {\n    if (this.buffer.length === 0) return\n\n    const metrics = [...this.buffer]\n    this.buffer = []\n\n    const batch: TelemetryBatch = {\n      serverName: this.config.serverName,\n      serverVersion: this.config.serverVersion,\n      metrics,\n      meta: {\n        sdkVersion: SDK_VERSION,\n        nodeVersion: typeof process !== 'undefined' ? process.version : 'unknown',\n        platform: typeof process !== 'undefined' ? process.platform : 'unknown',\n      },\n    }\n\n    this.log('Flushing metrics', { count: metrics.length })\n\n    try {\n      const response = await fetch(this.config.endpoint, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${this.config.apiKey}`,\n          'X-OpenConductor-SDK': SDK_VERSION,\n        },\n        body: JSON.stringify(batch),\n      })\n\n      if (!response.ok) {\n        throw new Error(`Telemetry flush failed: ${response.status} ${response.statusText}`)\n      }\n\n      this.log('Metrics flushed successfully', { count: metrics.length })\n    } catch (error) {\n      // Put metrics back in buffer on failure\n      this.buffer.unshift(...metrics)\n      throw error\n    }\n  }\n\n  /**\n   * Stop telemetry collection\n   */\n  shutdown(): void {\n    if (this.flushTimer) {\n      clearInterval(this.flushTimer)\n      this.flushTimer = null\n    }\n    this.flush().catch(this.handleError.bind(this))\n    this.log('Telemetry shutdown')\n  }\n\n  private log(message: string, data?: Record<string, unknown>): void {\n    if (this.config.debug) {\n      console.debug(JSON.stringify({\n        timestamp: new Date().toISOString(),\n        level: 'debug',\n        service: 'openconductor-telemetry',\n        message,\n        ...data,\n      }))\n    }\n  }\n\n  private handleError(error: unknown): void {\n    if (this.config.debug) {\n      console.error('[OpenConductor Telemetry Error]', error)\n    }\n  }\n}\n"]}